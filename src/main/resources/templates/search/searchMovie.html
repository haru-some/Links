<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>검색 결과</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick-theme.css">
    <style>
    .result-wrap{
    	margin-left : 100px;
    }
    
    .carousel-inner>.carousel-item>.d-flex{
	justify-content: space-between;
	margin-left : 20px;
	margin-right : 20px;
	}
	
	.carousel-inner{
		height : 400px;
		margin-top : 30px;
		margin-bottom : 30px;
		align-content: center;
	}
	
	.card {
	    height: 400px;
	    width: 220px;
	    border: 1px solid #ddd;
	    border-radius: 8px;
	    overflow: hidden;
	    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
	    text-align: center;
	    position: relative;
	    transition: transform 0.3s ease, box-shadow 0.3s ease;
	}
	/* 호버 효과 */
	.card:hover {
	    transform: scale(1.05);
	    box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.2);
	    cursor: pointer;
	}
	
	.rank-badge {
	    position: absolute;
	    top: 10px;
	    left: 10px;
	    background-color: black;
	    color: white;
	    font-size: 14px;
	    font-weight: bold;
	    width: 30px;
	    height: 30px;
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    border-radius: 4px;
	}
	.img-div{
	    width: 100%;
	    height: 65%;
	}
	.card-img-top {
		width : 100%;
		height : 100%;
	    object-fit: fill;
	    background-color: #f0f0f0;
	}
	
	.card-body {
	    padding: 5px;
	    font-size: 14px;
	}
	
	.card-title {
		height: 30%;
	    font-size: 16px;
	    font-weight: bold;
	    margin-bottom: 4px;
	    word-wrap: break-word
	}
	
	.card-info {
	    font-size: 12px;
	    color: gray;
	}
	
	.rating {
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    font-size: 12px;
	    margin: 5px 0;
	}
	
	.rating .star {
	    color: gold;
	    margin-right: 5px;
	}
	
	.genre-info {
		height :30%;
		display : flex;
		justify-content : center;
		align-items : center;	
	    font-size: 12px;
	    color: black;
	    gap : 5px;
	    flex-wrap: wrap;
	}
	.genre-info>p {
		margin : 0;
	}
	.carousel>.carousel-control-prev{
		width : 40px;
		top : 40%;
		height : 10%;
		background-color : black;
	}
	.carousel>.carousel-control-next{
		width : 40px;
		top : 40%;
		height : 10%;
		right : -35px;
		background-color : black;
	}
   </style>
</head>
<body>
    <th:block th:include="common/header"></th:block>
    <section class="page-section" id="services">
    <div class="container-fluid mt-3">
        <div class="result-wrap text-start mt-4">
            <span class="fw-bold" style="font-size: 30px; font-family: ns-r;">"</span>
            <span id="searchKeyword" class="fw-bold text-orange" style="font-size: 30px; font-family: ns-r;" th:text="${query}"></span>
         	<span class="fw-bold" style="font-size: 30px; font-family: ns-r;">" 의 검색 결과</span>
        </div>
        <div class="result-keyword-wrap mt-2">
            <input type="hidden" id="queryValue" th:value="${query}">
        </div>
    	<div class="container mt-2">
		    <div id="movieCarousel1" class="carousel slide" > <!-- data-bs-ride="carousel" -->
		        <div class="carousel-inner" id="carousel1"></div>
		        <button class="carousel-control-prev" type="button" data-bs-target="#movieCarousel1" data-bs-slide="prev">
		            <span class="carousel-control-prev-icon"></span>
		        </button>
		        <button class="carousel-control-next" type="button" data-bs-target="#movieCarousel1" data-bs-slide="next">
		            <span class="carousel-control-next-icon"></span>
		        </button>
		    </div>
		</div>
    </div>
    
    
    <!-- <div class="container-fluid mt-3">
        검색 결과 제목
        검색어 출력
        <div class="result-wrap text-start mt-4">
            <span class="fw-bold" style="font-size: 30px; font-family: ns-r;">"</span>
            <span id="searchKeyword" class="fw-bold text-orange" style="font-size: 30px; font-family: ns-r;"></span>
         	<span class="fw-bold" style="font-size: 30px; font-family: ns-r;">" 의 검색 결과</span>
        </div>
        검색어 저장소
        <div class="result-keyword-wrap mt-2">
            <input type="hidden" id="queryValue" th:value="${query}">
        </div>
        
        슬라이드 형식의 영화 리스트
        <div class="mt-4">
            <div class="movie-slider" id="movieSlider">
                동적으로 카드가 추가됨
            </div>
        </div>
    </div> -->
	</section>
    <th:block th:include="common/footer"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick.min.js"></script>
    <script inline="javascript">
    const query = $("#queryValue").val().trim();
    if (!query || query === "undefined") {
        $("#searchKeyword").text("검색어가 없습니다.");
    }
    $("#searchKeyword").text(query);
    
    console.log(query);
    function search(){
		$.ajax({
			url : "/api/searchResult",
			type : "get",
			data : {"query":query},
			success : function(movies){
				const carouselContent = $("#carousel1");
				makeSlide(movies,carouselContent);
			}    
		});
	}
    
    function makeSlide(obj1,obj2){
		const movies = obj1;
		const carouselContent = obj2;
        let slideIndex = 0;
        let indexNo= 1;
        for (let i = 0; i < movies.length; i += 5) {
            let moviesSlice = movies.slice(i, i + 5);
            let isActive = slideIndex === 0 ? "active" : "";
            let slide = $("<div>").addClass(`carousel-item ${isActive}`);
            let row = $("<div>").addClass("row d-flex ");

            
            $.each(moviesSlice, function (index, movie) {
                let col = $("<div>").addClass("col-md-2 mx-1");
				let imgSrc = "https://image.tmdb.org/t/p/w342";				
                if(movie.posterPath!=null){
                	imgSrc += movie.posterPath;
                }else{
                	imgSrc = "/image/No_Image.jpg";
                }
                let card = $("<div>").addClass("card");
                const id = movie.movieId;
                card.on('click',function(){
                	location.href = "/api/movieDetail?movieId="+id;
                });
                let rankBadge = $("<div>").addClass("rank-badge").text(indexNo++);
                let img = $("<img>").addClass("card-img-top").attr("src", imgSrc);
                let imgDiv = $("<div>").addClass("img-div").append(img);

                let cardBody = $("<div>").addClass("card-body");
                let title = $("<div>").addClass("card-title").text(movie.title);
                let info = $("<div>").addClass("card-info").text(movie.releaseDate);
                
                let rating = $("<div>").addClass("rating");
                //let ratingText = $("<span>").text(movie.rating);
                //rating.append(star);
                let genreInfo = $("<div>").addClass("genre-info");						
                $.each(movie.genreIds, function(index, genre){
                	const p = $("<p>").append(genre);
                	genreInfo.append(p);
                });
                // 카드 조립
                cardBody.append(title, info, rating, genreInfo);
                card.append(rankBadge, imgDiv, cardBody);
                col.append(card);
                row.append(col);
            });
            slide.append(row);
            carouselContent.append(slide);
            slideIndex++;
        }
	}
    
    
    /* $(document).ready(function() {
        var query = $("#queryValue").val().trim();
        //console.log("검색어:", query);

        if (!query || query === "undefined") {
            $("#searchKeyword").text("검색어가 없습니다.");
            return;
        }

        $("#searchKeyword").text(query);

        $.ajax({
            url: window.location.origin + "/api/movie/search",
            type: "GET",
            data: { query: query },
            success: function(response) {
                //console.log("TMDB API 응답:", response);

                var movies = response.results;
                var slider = $("#movieSlider");
                slider.empty();

                if (!movies || movies.length === 0) {
                    slider.append("<p class='text-danger'>검색 결과가 없습니다.</p>");
                    return;
                }

                $.each(movies, function(index, movie) {
                    var imageUrl = movie.poster_path 
                        ? "https://image.tmdb.org/t/p/w500" + movie.poster_path 
                        : window.location.origin + "/images/no-image.png";
                    
                    const moviecard = $("<div>");
                    moviecard.addClass("movie-card");
                    
                    var card = `
                            <img src="${imageUrl}" alt="${movie.title}">
                            <div class="p-3">
                                <h6 class="card-title">${movie.title}</h6>
                                <p class="text-muted">개봉일: ${movie.release_date}</p>
                            </div>
                        `;
                    moviecard.append(card);
                    slider.append(moviecard);
                    
                    var movieId = movie.id
                    moviecard.on('click',function(){
                    	location.href = "/api/movieDetail?movieId="+movieId;
                    });
                });
                              

                // ✅ Slick.js 초기화
                slider.slick({
                    slidesToShow: 5,
                    slidesToScroll: 5,
                    arrows: true,
                    dots: true,
                    infinite: true,
                    speed: 500,
                });
            },
            error: function(xhr, status, error) {
                console.error("AJAX 요청 오류:", error);
                alert("영화 검색 중 오류 발생");
            }
        });
    }); 
    */
    search();
    </script>
</body>
</html>
